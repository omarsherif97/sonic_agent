"""
<script language="js"><![CDATA[
(function () {
    /* 0. Configuration -------------------------------------------- */
    var BILLS_PATH    = 'bills';          // change if the array name differs
    var RANGE_KEY     = 'paymentRange';   // change or move to mc property
    var ADD_TOTAL_AMT = true;             // set false to skip TotalBillAmt

    /* 1. Helpers --------------------------------------------------- */
    function isTrue(v){return v===true||(typeof v==='string'&&v.toLowerCase()==='true');}
    function esc(s){return String(s).replace(/[&<>'"]/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&apos;','"':'&quot;'}[c];});}

    /* 3. Parse JSON ------------------------------------------------ */
    var root; try{root=mc.getPayloadJSON();}catch(e){log.error('Bad JSON',e);return;}
    var bills = root && Array.isArray(root[BILLS_PATH]) ? root[BILLS_PATH] : [];
    if (!bills.length){mc.setProperty('multiOptionsPayload','<MultiOptions/>');return;}

    /* 4. Build XML ------------------------------------------------- */
    var x=[]; x.push('<MultiOptions>');
    bills.forEach(function(b){
        x.push('<option>');
        Object.keys(b).forEach(function(k){
            var v=b[k];

            /* Special case for the nested range object ------------- */
            if(k===RANGE_KEY && typeof v==='object'){
                if(v.lower!==undefined) x.push('<param><key>PaymentLowerRange</key><value>',esc(v.lower),'</value></param>');
                if(v.upper!==undefined) x.push('<param><key>PaymentUpperRange</key><value>',esc(v.upper),'</value></param>');
                if(v.currencyCode!==undefined) x.push('<param><key>CurrencyCode</key><value>',esc(v.currencyCode),'</value></param>');
                return; // skip normal handling
            }

            /* Emit generic param ----------------------------------- */
            var keyTag = k.charAt(0).toUpperCase()+k.slice(1); // BillRefNumber style
            x.push('<param><key>',keyTag,'</key><value>',esc(v),'</value></param>');
        });

        /* Always append TotalBillAmt if wanted & amount present ---- */
        if(ADD_TOTAL_AMT && b.amount!==undefined){
            x.push('<param><key>TotalBillAmt</key><value>',esc(b.amount),'</value></param>');
        }
        x.push('</option>');
    });
    x.push('</MultiOptions>');
    mc.setProperty('multiOptionsPayload',x.join(''));
})();
]]></script>


"""