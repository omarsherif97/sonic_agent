package com.raya.aman.cashoutin.processors;

import java.util.Date;
import java.util.HashMap;

import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.eclipse.jetty.http.HttpMethods;

import com.raya.aman.cashoutin.model.CashRequest;
import com.raya.aman.cashoutin.model.StatusEnum;
import com.raya.aman.dal.DataAccessManager;
import com.raya.aman.dal.model.CashInOutTransactionLogs;
import com.raya.aman.logger.AmanLogger;
import com.raya.aman.util.configuration.PropertyInit;
import com.raya.aman.util.exception.CustomException;

public class CashInProcessor implements Processor {

	public static final String AMAN_MSISDN = "AMAN_MSISDN";

	public static final String AMAN_LOGIN = "AMAN_LOGIN";

	public static final String AMAN_PASSWORD = "AMAN_PASSWORD";

	public static final String AMAN_GATEWAY_CODE = "AMAN_GATEWAY_CODE";

	public static final String AMAN_GATEWAY_TYPE = "AMAN_GATEWAY_TYPE";

	public static final String AMAN_PIN = "AMAN_PIN";

	public static final String Language = "3";

	public static final String CASH_IN_RQ = "ARCIREQ";// Initiation

	@Override
	public void process(Exchange exchange) throws Exception {

		CashInOutTransactionLogs log = (CashInOutTransactionLogs) DataAccessManager
				.queryForObject("cashinout_selectBy",
						exchange.getProperty("referenceNumber"));
		if (log != null) {
			if (log.getStatus().equals(StatusEnum.CASHOUT_INIT.getCode())
					|| log.getStatus().equals(StatusEnum.TIMEOUT.getCode())) {
				throw new CustomException(exchange.getContext()
						.resolvePropertyPlaceholders("{{005}}"));
			}
		}

		exchange.getIn().setHeaders(new HashMap<String, Object>());
		exchange.getIn()
				.setHeader(
						org.apache.camel.component.cxf.common.message.CxfConstants.OPERATION_NAME,
						"CashIn");

		AmanLogger.logInfo(PropertyInit.getLOGGERNAME(),
				"Payment Properties *** ", exchange.getProperties().values()
						.toString());

		CashRequest cashRequest = new CashRequest();

		String billRefId = (String) exchange.getProperty("referenceNumber");
		if (billRefId == null || "".equals(billRefId)) {

			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"),
					"Missing Bill Reference Number");

			throw new CustomException("Missing Bill Reference Number");
		}

		String amount = (String) exchange.getProperty("amount");
		if (amount == null || "".equals(amount)) {

			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"),
					"Missing CashIn Payment Amount.");
			throw new CustomException("Missing CashIn Payment Amount.");
		}

		String transId = (String) exchange.getProperty("transactionId");
		if (transId == null || "".equals(transId)) {

			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"));
			throw new CustomException("Missing Aman Transaction Id.");
		}

		// String amanMsisdn =
		// exchange.getContext().resolvePropertyPlaceholders(
		// "{{" + AMAN_MSISDN + "}}");

		MsisdnProcessor msisdnproc = new MsisdnProcessor();
		msisdnproc.process(exchange);

		String amanMsisdn = (String) exchange.getProperty("amanMsisdn");

		if (amanMsisdn == null || amanMsisdn.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"));
			throw new CustomException("Missing CashIn Agent Msisdn.");
		}

		String amanGateWayCode = exchange.getContext()
				.resolvePropertyPlaceholders("{{" + AMAN_GATEWAY_CODE + "}}");

		if (amanGateWayCode == null || amanGateWayCode.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"),
					"Missing CashIn Agent Gateway Code.");
			throw new CustomException("Missing CashIn Agent Gateway Code");
		}

		String amanGateWayType = exchange.getContext()
				.resolvePropertyPlaceholders("{{" + AMAN_GATEWAY_TYPE + "}}");

		if (amanGateWayType == null || amanGateWayType.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"),
					"Missing CashIn Agent Gateway Type.");
			throw new CustomException("Missing CashIn Agent Gateway Type");
		}

		String login = exchange.getContext().resolvePropertyPlaceholders(
				"{{" + AMAN_LOGIN + "}}");

		if (login == null || login.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"));
			throw new CustomException("Missing CashIn Agent login");
		}

		String password = exchange.getContext().resolvePropertyPlaceholders(
				"{{" + AMAN_PASSWORD + "}}");

		if (password == null || password.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"),
					"Missing CashIn Agent password.");
			throw new CustomException("Missing CashIn Agent password");
		}

		String amanPin = exchange.getContext().resolvePropertyPlaceholders(
				"{{" + exchange.getProperty("serviceCode", String.class) + "_" + AMAN_PIN + "}}");

		if (amanPin == null || amanPin.equals("")) {
			AmanLogger.logInfo(PropertyInit.getLOGGERNAME(), exchange
					.getContext().resolvePropertyPlaceholders("{{000}}"));
			throw new CustomException("Missing CashIn Agent Pin.");
		}

		cashRequest.setLogin(login);
		cashRequest.setPassword(password);
		cashRequest.setRequestGateCode(amanGateWayCode);
		cashRequest.setRequestGateType(amanGateWayType);

		cashRequest.setType(CASH_IN_RQ);
		cashRequest.setMsisdn(amanMsisdn);
		cashRequest.setMsisdn2(billRefId);
		cashRequest.setAmount(amount);
		cashRequest.setIdno(transId);
		cashRequest.setLang1(Language);
		cashRequest.setLang2(Language);
		cashRequest.setPin(amanPin);

		String senderScheme = exchange.getContext()
				.resolvePropertyPlaceholders(
						"{{"
								+ exchange.getProperty("serviceCode",
										String.class) + "_senderScheme}}");
		String recipientScheme = exchange.getContext()
				.resolvePropertyPlaceholders(
						"{{"
								+ exchange.getProperty("serviceCode",
										String.class) + "_recipientScheme}}");

		cashRequest.setSenderScheme(senderScheme);
		cashRequest.setRecipientScheme(recipientScheme);

		/*
		 * "LOGIN": "AMAN", "PASSWORD": "Tjefrgqk277", "REQUEST_GATEWAY_CODE":
		 * "AMAN", "REQUEST_GATEWAY_TYPE": "AMAN", "TYPE": "RCIREQ", "MSISDN":
		 * "00201111515153", "MSISDN2": "00201111515154", "AMOUNT": "10",
		 * "IDNO": "1", "LANGUAGE1": "1", "LANGUAGE2": "1", "PIN": "123456"
		 */

		exchange.getIn().setHeader("requestDate", new Date());
		exchange.setProperty("RequestCode", CASH_IN_RQ);
		// these parameters must to be set in the header of the request

		exchange.getIn().setHeader(Exchange.HTTP_METHOD, HttpMethods.POST);
		exchange.getIn().setHeader(Exchange.CONTENT_TYPE, "application/json");
		exchange.getIn().setBody(cashRequest);

	}

}
