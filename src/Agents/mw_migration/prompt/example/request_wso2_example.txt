<?xml version="1.0" encoding="UTF-8"?>
<sequence name="aman-paymob-vodafone-cashin-inquiry-request" onError="aman-paymob-vodafonecash-fault-test" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="Aman VodafoneCashIn Inquiry Request" level="custom">
        <property name="Cashin_Inquiry_Request" value="Starting Aman Vodafone Cashin Inquiry Request"/>
    </log>
    <filter xpath="string-length(get-property('msisdn')) = 0 or get-property('msisdn') = ''">
        <then>
            <property name="exceptionCode" scope="default" type="STRING" value="300001"/>
            <property name="exceptionMessage" scope="default" type="STRING" value="Missing Bill Reference Number"/>
            <sequence key="aman-paymob-vodafone-custom-exception"/>
        </then>
        <else/>
    </filter>
    <!-- Dataservice connection -->
    <payloadFactory media-type="xml">
        <format>
            <soapenv:Envelope xmlns:dat="http://ws.wso2.org/dataservice" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                <soapenv:Header/>
                <soapenv:Body>
                    <dat:select_with_key_CASHINOUT_TRANSACTION_LOG_operation_v1>
                        <dat:BILL_REFERENCE_NUMBER>$1</dat:BILL_REFERENCE_NUMBER>
                    </dat:select_with_key_CASHINOUT_TRANSACTION_LOG_operation_v1>
                </soapenv:Body>
            </soapenv:Envelope>
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('msisdn')"/>
        </args>
    </payloadFactory>
    <log description="LogCashInquiryTransactionLogsDSReq" level="full"/>
    <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
    <property name="ContentType" scope="transport" type="STRING" value="application/xml; charset=UTF-8"/>
    <call>
        <endpoint key="aman-mw-dataservice-endpoint"/>
    </call>
    <log description="LogCashInquiryTransactionLogsDSRes" level="full"/>
    <property expression="$body" name="cashTransactionLogsBody" scope="default" type="STRING"/>
    <property name="namespace" scope="default" type="STRING" value="http://ws.wso2.org/dataservice"/>
    <property expression="//ns:CASHINOUT_TRANSACTION_LOG/ns:STATUS/text()" name="cashinLogStatus" scope="default" type="STRING" xmlns:ns="http://ws.wso2.org/dataservice"/>
    <filter xpath="get-property('cashinLogStatus') = 5 or get-property('cashinLogStatus') = 3">
        <then>
            <property name="exceptionCode" scope="default" type="STRING" value="300001"/>
            <property name="exceptionMessage" scope="default" type="STRING" value="توجد عملية معلقة لهذا الرقم. يرجى استخدام استعلام عن العملية"/>
            <sequence key="aman-paymob-vodafone-custom-exception"/>
        </then>
        <else/>
    </filter>
    <payloadFactory media-type="xml">
        <format>
            <soapenv:Envelope xmlns:dat="http://ws.wso2.org/dataservice" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                <soapenv:Header/>
                <soapenv:Body>
                    <dat:select_with_key_MERCHANT_WALLET_MAPPER_operation_v1>
                        <dat:MERCHANT_DBID>$1</dat:MERCHANT_DBID>
                        <dat:ISSUER_DBID>Vodafone_Cash</dat:ISSUER_DBID>
                    </dat:select_with_key_MERCHANT_WALLET_MAPPER_operation_v1>
                </soapenv:Body>
            </soapenv:Envelope>
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('terminalId')"/>
        </args>
    </payloadFactory>
    <log description="LogCashInInquirySelectMerchantMsisdnDsRqV1" level="full"/>
    <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
    <property name="ContentType" scope="transport" type="STRING" value="application/xml; charset=UTF-8"/>
    <call>
        <endpoint key="aman-mw-dataservice-endpoint"/>
    </call>
    <log description="LogCashInInquirySelectMerchantMsisdnDsRsV1" level="full"/>
    <property name="namespace" scope="default" type="STRING" value="http://ws.wso2.org/dataservice"/>
    <property expression="//ns:MERCHANT_WALLET_MAPPER/ns:MERCHANT_ID/text()" name="merchandMsisdn" scope="default" type="STRING" xmlns:ns="http://ws.wso2.org/dataservice"/>
    <filter xpath="string-length(get-property('merchandMsisdn')) = 0 or get-property('merchandMsisdn') = ''">
        <then>
            <property name="exceptionCode" scope="default" type="STRING" value="300001"/>
            <property name="exceptionMessage" scope="default" type="STRING" value="Missing CashIn Confirm Agent Msisdn"/>
            <sequence key="aman-paymob-vodafone-custom-exception"/>
        </then>
        <else/>
    </filter>
    <header name="operationName" scope="transport" value="CashIn"/>
    <payloadFactory media-type="json">
        <format>
			{
			    "LOGIN": "AMAN",
			    "PASSWORD": "Deraq2ed2",
			    "REQUEST_GATEWAY_CODE": "AMAN",
			    "REQUEST_GATEWAY_TYPE": "AMAN",
			    "TYPE": "ARCIREQ",
			    "MSISDN": "$1",
			    "MSISDN2": "$2",
			    "AMOUNT": "$3",
			    "IDNO": "$4",
			    "LANGUAGE1": "3",
			    "LANGUAGE2": "3",
			    "PIN": "502779",
			    "SENDERSCHEME": "VodafoneCash",
			    "RECIPIENTSCHEME": "VodafoneCash"
			}
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('merchandMsisdn')"/>
            <arg evaluator="xml" expression="get-property('msisdn')"/>
            <arg evaluator="xml" expression="get-property('amount')"/>
            <arg evaluator="xml" expression="get-property('GLETxnID')"/>
        </args>
    </payloadFactory>
    <log description="LogCashinInquiryRequest" level="full"/>
    <call>
        <endpoint key="vodafone-cashin-inquiry"/>
    </call>
</sequence>
